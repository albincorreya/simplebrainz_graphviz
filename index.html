<!DOCTYPE html>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- Optimized from http://biohackathon.org/d3sparql/d3sparql.html -->
		<html>
		<head>
		<!--<link rel="stylesheet" type="text/css" href="index.css">-->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<link rel="stylesheet" href="./style.css">
		<!--<title>simplebrainz.org</title>-->
		<div id="simplebrainzhead" class="tabcontent">
			<h1>Simplebrainz</h1>
		</div>
		</head>
		<script src="https://d3js.org/d3.v3.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>-->
		<script src="./src/d3sparql.js"></script>
		<script src="./data/testjson.js"></script>
		<script src="./src/dataviz.js"></script>>
		<script>
		///*

			//global variables

			window.onload = function(){
				$('#filter').find('option').remove().end();
				populateFilterOptions(['None']);
			}

			var outputJSON;
			var jsonLabel;
			var endpoint = "http://localhost:8890/sparql";
			var format = "application/sparql-results+json";



			var config = {
			"label": "name",
			"radius": 25 || function(d) { return d.value ? scale(d.value) : 1 + d.label.length },
			"charge": -800,
			"distance": 180,
			"width": 1450,
			"height": 1200,
			"selector": "#result",
			"gravity": .50,
			"friction": .9,
			"ClusterPadding": 1
			};


			function formatUri(){
			var mbid = d3.select("#mbid").property("value");
			//var mbid = "83d91898-7763-47d7-b03b-b92132375c47";
			var entity = d3.select("#entity").property("value");
			//var entity = "artist";
			return "http://musicbrainz.org/"+entity+"/"+mbid
			}



			function getRequestUrl(entity,mbid){
				var query = parseInnerQuery(entity,mbid);
				var url = endpoint + "?query=" + encodeURIComponent(query);
				return url
			}

			function xmlRequest(){
			var url = getRequestUrl("artist","83d91898-7763-47d7-b03b-b92132375c47");
			console.log(url);   
			xmlhttp = new XMLHttpRequest();
			xmlhttp.open("GET",url);
			xmlhttp.onreadystatechange = readystateParseEntityName();
			xmlhttp.send();
			}

			function readystateParseEntityName(){
				var response;
				if (this.readyState == 4){
						response = JSON.stringify(this.responseText);
						console.log(this.responseText);
						return response;
					}
			}


			function xhrEntityName(entity, mbid){
				//endpoint = "http://localhost:8890/sparql";
				//var format = "application/sparql-results+json";
				var query = parseInnerQuery(entity,mbid);
				var url = endpoint + "?query=" + encodeURIComponent(query);
				console.log(url);
				d3.xhr(url, format, function(request) {
					jsonLabel = JSON.parse(request.responseText);
					//window.alert("label done")
				});
				return jsonLabel.results.bindings[0].o.value
			}



			function testAjax(entity, mbid){
				var response;
				var query = parseInnerQuery(entity,mbid);
				var uri = endpoint + "?query=" + encodeURIComponent(query);
				console.log(uri);
				$.ajax({ 
					type: 'GET',
					url: uri, 
					data: JSON.stringify({ get_param: 'value' }),
					dataType: format,
					success: function (json) { 
						console.log(JSON.stringyfy(json.topics));
						parser = new DOMParser();
						response = parser.parseFromString(txt,JSON.stringyfy(json.topics));
					}
				});
				return response
			}

			/*
			function callBack(myJson){
				console.log(myJson.results.bindings[0].o.value);
				return myJson.results.bindings[0].o.value;

			}
			*/




			function onclickSearch(){
				//var endpoint ="http://localhost:8890/sparql";
				//var query = "select ?s ?p ?o WHERE {{<http://simplebrainz.org/song/b153e1a6-a1ee-4666-9deb-93369348bd4e#_> ?p ?o} UNION {?s ?p <http://simplebrainz.org/song/b153e1a6-a1ee-4666-9deb-93369348bd4e#_>}}";
				//var endpoint = "https://dbpedia.org/sparql";
				var query = d3.select("#sparql").property("value");
				//var format = "application/sparql-results+json";
				if(query.length<6 && toggle()==0){
					var query = "SELECT * WHERE{ ?s ?p ?o} LIMIT 50";
				}
				/*
				if(document.querySelector('.messageCheckbox:checked').value=='on'){
					var query=d3.select("#sparql").property("value");
					if(query.length<6 && toggle()==0){
						var query = "SELECT DISTINCT WHERE{ ?s ?p ?o} LIMIT 50";
						document.getElementById('myTextarea').value = query;
					}
				}else{
					var query = parseQuery(d3.select("#entity").property("value"),d3.select("#mbid").property("value"));
				}
				*/
				var url = endpoint + "?query=" + encodeURIComponent(query);
				//var url = endpoint + '?' + querypart;
				//var format = "application/json";
				d3.xhr(url, format, function(request) {
				outputJSON = JSON.parse(request.responseText);
					//sampleGraph();
					console.log;("Successful request!");
			})
			}

			//function sampleGraph(){d3sparql.forcegraph(outputJSON,config);}

			function toggle(){return 0;}

			function parseSearch(){
				var format = "application/sparql-results+json";
				var mbid = d3.select("#mbid").property("value");
				var entity = d3.select("#entity").property("value");
				var query = parseQuery(entity,mbid);
				var url = endpoint + "?query=" + encodeURIComponent(query);
				d3.xhr(url, format, function(request) {
					outputJSON = JSON.parse(request.responseText);
					updateGraph(outputJSON);
					window.alert("Successful request!");
				})
				return outputJSON;
			}



			function myGraph(){
				populateFilterOptions(getRelationships(parseJsonTest));
				var outGraph = outputParser(parseJsonTest);
				myForceGraph(outGraph,config);
			}


			function updateGraph(jsonout){
				populateFilterOptions(getRelationships(jsonout));
				myForceGraph(outputParser(jsonout),config);
			}

			function demoQuery(){
				parseSearch();
				updateGraph(outputJSON);
			}


			function removeOptions(){$('#filter').find('option').remove().end();};



			function getRelationships(json){
				var relArray = [];
				relArray[0] = "None";
				var myJSON = json.results.bindings;
				var j = 1;
				for(var i=3; i<myJSON.length; i++){
					relArray[j] = parseMbid(myJSON[i].p.value);
					j++;
				}
				function unique(list) {
					var result = [];
					$.each(list, function(i, e) {
					if ($.inArray(e, result) == -1) result.push(e);
					});
					return result;
				}
				var outArray = unique(relArray).filter(function( element ) {
					return element !== undefined;
				});
				return outArray;
			}

			function populateFilterOptions(filters){ 
				removeOptions(); 
				var sel = document.getElementById('filter');
				var fragment = document.createDocumentFragment();
				filters.forEach(function(filters, index) {
				var opt = document.createElement('option');
				opt.innerHTML = filters;
				opt.value = filters;
				fragment.appendChild(opt);
			});
			sel.appendChild(fragment);
			}
/*


			document.addEventListener("DOMContentLoaded", function(event) {
				console.log("DOM fully loaded and parsed");
			});

*/
		</script>

  <body>
	<div id="dropdown" style="margin: 10px">
	  <form class="form-inline">
				<!--<label for="test">SPARQL : <input class="messageCheckbox" type="checkbox" id="toggletick" /></label>-->
		<label>SPARQL:</label>
		<div class="input-append">
		<textarea id="sparql" class="span9" rows="3" cols="100" style="width:280px;">
SELECT * WHERE{ ?a ?b ?c} LIMIT 100
		</textarea>
		<label>MBID:</label>
		<textarea id="mbid" class="span9" rows="1" cols="300" style="width:300px;">83d91898-7763-47d7-b03b-b92132375c47</textarea>
		<label>Entity:</label>
		<select id="entity" name="mydropdown">
			<option value="artist">Artist</option>
			<option value="release-group">Release-Group</option>
			<option value="recording">Recording</option>
			<option value="work">Work</option>
			<option value="area">Area</option>
		</select>
		<label>Filter by:</label>
		<select id="filter" name="mysortlist">
			<option value="None">None</option>
		<!--
			<option value="All">All</option>
			<option value="artist">Members</option>
			<option value="release-group">Tribute_artists</option>
			<option value="Recordings">supporting__by</option>
			<option value="Work">Work</option>
			<option value="Area">Area</option>
		-->
		</select>
	<button class="btn btn-primary" type="button" onclick="demoQuery();">Query</button>
	</div>
	</form>
	</div>
	<div id="result"></div>
		<div class="footer">
	<p>simplebrainz.org, Music Technology Group, UPF, Barcelona</p>
		</div>
  </body>
</html>
